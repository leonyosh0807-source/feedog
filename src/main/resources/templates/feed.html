<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食事入力 | Feedog</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 0; background:#f6f7fb; color:#111; }
    header { padding: 16px 18px; background:#fff; border-bottom:1px solid #e7e7ee; }
    header h1 { margin:0; font-size:18px; }
    main { max-width: 720px; margin: 0 auto; padding: 18px; }
    .card { background:#fff; border:1px solid #e7e7ee; border-radius:12px; padding:16px; box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .row { display:grid; gap: 10px; margin-top: 12px; }
    label { font-size: 13px; color:#333; }
    input, select, textarea { width:100%; box-sizing:border-box; border:1px solid #d8d8e3; border-radius:10px; padding:10px 12px; font-size:15px; background:#fff; }
    textarea { min-height: 90px; resize: vertical; }
    .hint { font-size: 12px; color:#666; margin-top:6px; }
    .btns { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    button { border:none; border-radius:12px; padding: 12px 14px; font-size:16px; cursor:pointer; }
    .meal { background:#2f6fed; color:#fff; }
    .snack { background:#18a06b; color:#fff; }
    .sub { margin-top: 14px; display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    a { color:#2f6fed; text-decoration:none; }
    a:hover { text-decoration: underline; }
    .msg { margin-bottom: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid transparent; display:none; }
    .msg.ok { background:#ecfff6; border-color:#bfead5; color:#0b6b41; }
    .msg.ng { background:#fff0f0; border-color:#ffd2d2; color:#b40000; }
    .small { font-size: 12px; color:#666; }
  </style>
</head>

<body>
<header>
  <h1>食事入力</h1>
</header>

<main>
  <div id="msgOk" class="msg ok"></div>
  <div id="msgNg" class="msg ng"></div>

  <section class="card">
    <div class="row">
      <div>
        <label for="familyId">誰が（familyId）</label>
        <input id="familyId" type="number" inputmode="numeric" min="1" value="1" />
        <div class="hint">今は ID を直接入れる想定（将来は名前表示にできます）</div>
      </div>

      <div>
        <label for="petId">どのペット（petId）</label>
        <input id="petId" type="number" inputmode="numeric" min="1" value="1" />
      </div>

      <div>
        <label for="portion">量（portion）</label>
        <select id="portion">
          <!-- Portion enum 名を送る：LARGE / NORMAL / SMALL -->
          <option value="LARGE">多め</option>
          <option value="NORMAL" selected>普通</option>
          <option value="SMALL">少なめ</option>
        </select>
        <div class="hint">portion は Portion enum（LARGE/NORMAL/SMALL）として送信します</div>
      </div>

      <div>
        <label for="memo">メモ（memo / 任意）</label>
        <textarea id="memo" placeholder="例：完食 / 少し残した など"></textarea>
        <div class="hint">未入力でも登録できます</div>
      </div>

      <div class="btns">
        <!-- kind は FeedKind enum 名（FOOD / SNACK）を送る -->
        <button class="meal" id="btnFood" type="button">ごはん</button>
        <button class="snack" id="btnSnack" type="button">おやつ</button>
      </div>

      <div class="sub">
        <a href="/logs">ログ一覧へ</a>
        <span class="small">（API：POST /api/logs）</span>
      </div>
    </div>
  </section>
</main>

<script>
  function showOk(text) {
    const ok = document.getElementById("msgOk");
    const ng = document.getElementById("msgNg");
    ng.style.display = "none";
    ok.textContent = text;
    ok.style.display = "block";
  }

  function showNg(text) {
    const ok = document.getElementById("msgOk");
    const ng = document.getElementById("msgNg");
    ok.style.display = "none";
    ng.textContent = text;
    ng.style.display = "block";
  }

  function getNumberValue(id) {
    const v = document.getElementById(id).value.trim();
    if (v === "") return null;
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    return n;
  }

  async function postLog(kind) {
    const familyId = getNumberValue("familyId");
    const petId = getNumberValue("petId");
    const portion = document.getElementById("portion").value; // LARGE / NORMAL / SMALL
    const memoRaw = document.getElementById("memo").value;
    const memo = memoRaw.trim() === "" ? null : memoRaw;

    // 最低限のバリデーション（IDが入っていないと登録不能になりやすいのでここだけ必須扱い）
    if (familyId === null || petId === null) {
      showNg("familyId と petId は数値で入力してください（例：1）");
      return;
    }

    // FeedogLogRequest と一致する JSON を作る
    const body = {
      familyId: familyId,
      petId: petId,
      kind: kind,       // "FOOD" or "SNACK"
      portion: portion, // "LARGE" or "NORMAL" or "SMALL"
      memo: memo
    };

    try {
      const res = await fetch("/api/logs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const text = await res.text();
        showNg("登録に失敗しました（HTTP " + res.status + "）: " + text);
        return;
      }

      // FeedogLogResponse（JSON）
      await res.json();

      showOk("登録しました。ログ一覧へ移動します…");

      setTimeout(() => {
        window.location.href = "/logs";
      }, 300);

    } catch (e) {
      showNg("通信エラー: " + e);
    }
  }

  document.getElementById("btnFood").addEventListener("click", () => postLog("FOOD"));
  document.getElementById("btnSnack").addEventListener("click", () => postLog("SNACK"));
</script>
</body>
</html>
